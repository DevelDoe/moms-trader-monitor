<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MTP Alerts</title>
    <link rel="stylesheet" href="../styles.css" />

    <style>
      body {
        background-color: #1c1d23;
        color: #e0e0e0;
        font-size: 11px;
        position: relative;
        padding: 0;
        margin: 0 auto;
      }
      #log {
        overflow-y: auto;
        padding: 5px;
        border-radius: 5px;
        list-style-type: none;
        width: 200px;
      }
      .symbol-data {
        font-size: 15px;
      }
      #log li {
        float: left;
      }
      .alert {
        padding: 5px;
        margin: 5px 0;
        border-radius: 5px;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
        opacity: 0;
        animation: fadeIn 0.3s forwards;
      }
      .alert-symbol {
        margin-right: 3px;
      }
      .up {
        color: #28a745;
        border-left: 5px solid #28a745;
      }
      .down {
        color: #dc3545;
        border-left: 5px solid #dc3545;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      /* Symbol Summary */
      #symbol-summary {
        font-size: 14px;
        background-color: #1c1d23;
      }
      ul {
        padding: 0;
      }
      .symbol-item {
        padding: 3px;
        list-style-type: none;
        font-weight: bold;
        margin-bottom: 2px;
      }
      /* Progress bar styling */
      .progress-bar {
        display: inline-block;
        margin: 0 5px;
      }
      .segment {
        display: inline-block;
        width: 8px;
        height: 10px;
        background-color: #555;
        margin-right: 1px;
      }
      .segment.filled {
        background-color: #28a745;
      }
    </style>
  </head>
  <body class="draggable">
    <!-- <ul id="log"></ul> -->
    <div id="symbol-summary">
      <ul id="symbol-list"></ul>
    </div>

    <script>
      const ws = new WebSocket("ws://192.168.1.17:8000/ws");
      const logElement = document.getElementById("log");
      const symbolListElement = document.getElementById("symbol-list");
      const maxAlerts = 16;

      // Instead of tracking counts, track the latest percentage for each symbol.
      const symbolPercents = {};
      const symbolColors = {}; // For fixed background colors

      // Generate a distinct color for each symbol
      function getSymbolColor(symbol) {
        if (!symbolColors[symbol]) {
          const hash = [...symbol].reduce((acc, char) => acc + char.charCodeAt(0), 0);
          const hue = (hash * 37) % 360;
          const saturation = 80;
          const lightness = 50;
          const alpha = 0.5;
          symbolColors[symbol] = `hsla(${hue}, ${saturation}%, ${lightness}%, ${alpha})`;
        }
        return symbolColors[symbol];
      }

      // Update the symbol summary to display a progress bar (10 segments) based on the change percentage.
      function updateSymbolSummary() {
        // Clear the current list
        symbolListElement.innerHTML = "";
        // Iterate over each symbol in symbolPercents
        Object.entries(symbolPercents).forEach(([symbol, percent]) => {
          // Determine number of filled segments (rounding and capped at 10)
          const filledSegments = Math.min(10, Math.round(percent));
          let segmentsHtml = "";
          for (let i = 0; i < 10; i++) {
            segmentsHtml += i < filledSegments
              ? '<span class="segment filled"></span>'
              : '<span class="segment"></span>';
          }
          const li = document.createElement("li");
          li.className = "symbol-item";
          li.innerHTML = `
            <span style="background-color: ${getSymbolColor(symbol)}; padding: 2px 5px; border-radius: 3px;">${symbol}</span>
            <span class="progress-bar">${segmentsHtml}</span>
            <span>${percent.toFixed(2)}%</span>
          `;
          symbolListElement.appendChild(li);
        });
      }

      ws.onopen = function () {
        console.log("[CLIENT] Connected to WebSocket server");
        ws.send(JSON.stringify({ client_id: "web-client" }));
      };

      ws.onmessage = function (event) {
        console.log("[CLIENT] Received:", event.data);
        try {
          const alertData = JSON.parse(event.data);
          // Check for the expected fields (using updated names)
          if (
            !alertData.symbol ||
            !alertData.direction ||
            alertData.change_percent === undefined ||
            alertData.price === undefined ||
            alertData.volume === undefined
          ) {
            console.warn("[CLIENT] Received malformed alert:", alertData);
            return;
          }

          const symbol = alertData.symbol;
          const isUpTick = alertData.direction.toLowerCase() === "up";

          // For UP ticks, update the symbol percentage
          if (isUpTick) {
            symbolPercents[symbol] = alertData.change_percent;
            updateSymbolSummary();
          }

          // Create alert element
          const alertDiv = document.createElement("li");
          alertDiv.className = `alert ${alertData.direction.toLowerCase()}`;

          // Create symbol element with background color
          const coloredSymbol = `<span class="alert-symbol" style="background-color: ${getSymbolColor(symbol)}; 
            padding: 2px 5px; border-radius: 3px; color: #1c1d23;">${symbol}</span>`;

          alertDiv.innerHTML = `${coloredSymbol}<span class="symbol-data">
              <span>${alertData.change_percent.toFixed(2)}%</span> $${alertData.price.toFixed(2)}
              V${alertData.volume}</span>`;

          // Append new alert at the bottom
          logElement.appendChild(alertDiv);

          // Remove oldest alerts if exceeding maxAlerts
          while (logElement.children.length > maxAlerts) {
            logElement.removeChild(logElement.firstChild);
          }
        } catch (error) {
          console.error("[CLIENT] Error parsing message:", error);
        }
      };

      ws.onerror = function (error) {
        console.error("[CLIENT] WebSocket error:", error);
      };

      ws.onclose = function () {
        console.log("[CLIENT] Disconnected from WebSocket server");
      };
    </script>
  </body>
</html>
