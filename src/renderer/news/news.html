<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>News Viewer</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                padding: 10px;
                background-color: #1c1d23; /* Dark mode background */
                color: #e0e0e0; /* Light text for contrast */
            }

            table {
                width: 100%;
                border-collapse: collapse;
                background: #2a2b32; /* Darker background for table */
                color: #e0e0e0; /* Light text for readability */
            }

            th,
            td {
                border: 1px solid #3a3b41; /* Subtle border for separation */
                padding: 8px;
                text-align: left;
            }

            th {
                background: #3a3b41; /* Slightly lighter dark header */
                color: #ffffff; /* White text for contrast */
            }

            tr:nth-child(even) {
                background: #24252b; /* Alternating row color */
            }

            a {
                color: #66b3ff; /* Soft blue for links */
                text-decoration: none;
            }

            a:hover {
                text-decoration: underline;
            }

            img {
                max-width: 50px;
                height: auto;
            }

            h1 {
                -webkit-app-region: drag;
                color: #ffffff; /* White title */
            }

            .filter-container {
                margin-bottom: 10px;
            }

            input[type="checkbox"] {
                accent-color: #66b3ff; /* Matching checkbox color */
            }
        </style>
    </head>
    <body>
        <h1>News Headlines</h1>

        <div class="filter-container">
            <input type="checkbox" id="filter-checkbox" />
            <label for="filter-checkbox">Show only tracked tickers</label>
        </div>

        <table id="news-table">
            <thead>
                <tr>
                    <th>Ticker</th>
                    <th>Headline</th>
                    <th>Source</th>
                    <th>Time</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="6">Loading news...</td>
                </tr>
            </tbody>
        </table>

        <script>
            let allNews = [];
            let trackedTickers = new Set();
        
            async function fetchTrackedTickers() {
                console.log("üì¢ fetchTrackedTickers() called");
        
                try {
                    const tickers = await window.topAPI.getTickers("daily");
                    console.log("‚úÖ Received tickers from API:", tickers);
        
                    if (!Array.isArray(tickers)) {
                        console.error("‚ö†Ô∏è Expected an array from getTickers but got:", tickers);
                        return;
                    }
        
                    // ‚úÖ Normalize ticker symbols
                    trackedTickers = new Set(tickers.map((t) => t.Symbol?.toUpperCase()));
                    console.log("‚úÖ Tracked Tickers Updated:", trackedTickers);
        
                    // Refresh the table after tickers update
                    updateNewsTable();
                } catch (error) {
                    console.error("‚ö†Ô∏è Error fetching tracked tickers:", error);
                }
            }
        
            async function fetchNews() {
                console.log("üì¢ fetchNews() called");
        
                try {
                    const newsData = await window.newsAPI.get();
                    console.log("üì∞ Received news from API:", newsData);
        
                    if (!Array.isArray(newsData) || newsData.length === 0) {
                        console.warn("‚ö†Ô∏è No news received or invalid format:", newsData);
                    } else {
                        console.log("‚úÖ News data structure looks good!");
                    }
        
                    allNews = newsData;
                    updateNewsTable();
                } catch (error) {
                    console.error("‚ö†Ô∏è Error fetching news:", error);
                    document.querySelector("#news-table tbody").innerHTML = `<tr><td colspan="6">Error fetching news: ${error.message}</td></tr>`;
                }
            }
        
            function updateNewsTable() {
                console.log("üì¢ updateNewsTable() called with allNews:", allNews);
                
                const showOnlyTracked = document.querySelector("#filter-checkbox").checked;
                const tableBody = document.querySelector("#news-table tbody");
                tableBody.innerHTML = "";
        
                let filteredNews = allNews;
                if (showOnlyTracked) {
                    filteredNews = allNews.filter(({ ticker }) => trackedTickers.has(ticker?.toUpperCase())); // Match case
                }
        
                console.log("üìä Filtered News:", filteredNews);
        
                if (filteredNews.length === 0) {
                    console.warn("‚ö†Ô∏è No news available after filtering.");
                    tableBody.innerHTML = "<tr><td colspan='6'>No news available.</td></tr>";
                    return;
                }
        
                // ‚úÖ Flatten the array and sort all news by created_at in descending order (newest first)
                let sortedNews = filteredNews
                    .flatMap(({ ticker, news }) => {
                        if (!Array.isArray(news)) {
                            console.error(`‚ö†Ô∏è News for ticker ${ticker} is not an array:`, news);
                            return [];
                        }
                        return news.map((article) => ({ ...article, ticker: ticker?.toUpperCase() }));
                    }) // Normalize ticker
                    .sort((a, b) => new Date(b.created_at) - new Date(a.created_at)); // Sort by newest first
        
                console.log("üìä Sorted News Ready for Table:", sortedNews);
        
                // ‚úÖ Append sorted news to the table
                sortedNews.forEach((article) => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${article.ticker}</td>
                        <td><a href="${article.url}" target="_blank">${article.headline}</a></td>
                        <td>${article.source}</td>
                        <td>${new Date(article.created_at).toLocaleString()}</td>
                    `;
                    tableBody.appendChild(row);
                });
        
                console.log("‚úÖ News table updated successfully!");
            }
        
            // ‚úÖ Update tracked tickers when "tickers-updated" is received
            window.topAPI.onTickerUpdate(() => {
                console.log("üîÑ Received tickers-updated event. Refreshing tracked tickers...");
                fetchTrackedTickers();
            });
        
            // ‚úÖ Listen for **real-time socket-based news updates**
            window.newsAPI.onUpdate((newsData) => {
                console.log("üîÑ Received news update from socket:", newsData);
        
                if (!Array.isArray(newsData) || newsData.length === 0) {
                    console.warn("‚ö†Ô∏è No news received from socket update or format is incorrect:", newsData);
                    return;
                }
        
                console.log("‚úÖ Updating allNews with new socket data...");
                allNews = newsData;
                updateNewsTable();
            });
        
            document.querySelector("#filter-checkbox").addEventListener("change", updateNewsTable);
        
            // ‚úÖ Initial fetch for tickers and news
            fetchTrackedTickers();
            fetchNews();
        </script>
        
    </body>
</html>
