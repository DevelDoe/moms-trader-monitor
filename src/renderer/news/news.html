<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>News Viewer</title>
        <style>
            /* Your existing CSS styles */
        </style>
    </head>
    <body>
        <h1>News Headlines</h1>

        <div class="filter-container">
            <input type="checkbox" id="filter-checkbox" />
            <label for="filter-checkbox">Show only tracked tickers</label>
        </div>

        <table id="news-table">
            <thead>
                <tr>
                    <th>Ticker</th>
                    <th>Headline</th>
                    <th>Source</th>
                    <th>Time</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="6">Loading news...</td>
                </tr>
            </tbody>
        </table>

        <script>
            let allNews = [];
            let trackedTickers = new Set();

            async function getTickers() {
                try {
                    console.log("üì¢ Fetching tracked tickers...");

                    const tickers = await window.topAPI.getTickers("daily");
                    console.log("‚úÖ Received tickers:", tickers);

                    if (!Array.isArray(tickers)) {
                        console.error("‚ö†Ô∏è Expected an array but got:", tickers);
                        return;
                    }

                    // Normalize tickers for comparison
                    trackedTickers = new Set(tickers.map((t) => t.Symbol?.toUpperCase()));
                    console.log("‚úÖ Tracked Tickers Updated:", trackedTickers);

                    // Refresh news table since tickers have changed
                    updateNewsTable();
                } catch (error) {
                    console.error("‚ö†Ô∏è Error fetching tracked tickers:", error);
                }
            }

            async function fetchNews() {
                try {
                    console.log("üì¢ Fetching news...");

                    const newsData = await window.newsAPI.get(); // Fetch news from Electron API
                    console.log("üì∞ Received news:", newsData);

                    if (!Array.isArray(newsData)) {
                        console.error("‚ö†Ô∏è Expected an array but got:", newsData);
                        return;
                    }

                    allNews = newsData;
                    updateNewsTable();
                } catch (error) {
                    console.error("‚ö†Ô∏è Error fetching news:", error);
                    document.querySelector("#news-table tbody").innerHTML = `<tr><td colspan="6">Error fetching news: ${error.message}</td></tr>`;
                }
            }

            function updateNewsTable() {
                console.log("üì¢ Updating news table...");

                const showOnlyTracked = document.querySelector("#filter-checkbox").checked;
                const tableBody = document.querySelector("#news-table tbody");
                tableBody.innerHTML = "";

                let filteredNews = allNews;
                if (showOnlyTracked) {
                    filteredNews = allNews.filter((newsItem) => {
                        // Assuming newsItem has a 'symbols' array that contains the tickers
                        return newsItem.symbols && newsItem.symbols.some((symbol) => trackedTickers.has(symbol.toUpperCase()));
                    });
                }

                console.log("üìä Filtered News:", filteredNews);

                if (filteredNews.length === 0) {
                    console.warn("‚ö†Ô∏è No news available after filtering.");
                    tableBody.innerHTML = "<tr><td colspan='6'>No news available.</td></tr>";
                    return;
                }

                // Sort news by time (assuming there's a 'created_at' field)
                let sortedNews = filteredNews.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                console.log("üìä Sorted News Ready for Table:", sortedNews);

                // Append sorted news to the table
                sortedNews.forEach((article) => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${article.symbols ? article.symbols.join(', ') : 'N/A'}</td>
                        <td><a href="${article.url}" target="_blank">${article.headline}</a></td>
                        <td>${article.source || 'N/A'}</td>
                        <td>${new Date(article.created_at).toLocaleString()}</td>
                    `;
                    tableBody.appendChild(row);
                });

                console.log("‚úÖ News table updated!");
            }

            document.querySelector("#filter-checkbox").addEventListener("change", updateNewsTable);

            // Corrected Listener Syntax
            window.topAPI.onTickerUpdate(() => {
                console.log("üîÑ Received tickers-updated event. Refreshing tickers...");
                getTickers();
            });

            window.newsAPI.onUpdate(() => {
                console.log("üîÑ Received news update. Fetching fresh news...");
                fetchNews();
            });

            // Initial fetch for tickers and news
            getTickers();
            fetchNews();
        </script>
    </body>
</html>