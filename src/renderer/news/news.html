<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>News Viewer</title>
        <link rel="stylesheet" href="../styles.css" />
        <link rel="stylesheet" href="./news.css" />
    </head>
    <body>
        <div id="news-wrapper">
            <table id="news-table">
                <tbody>
                    <tr>
                        <td colspan="6">Loading news...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <script>
            let allNews = [];
            let trackedTickers = new Set();

            async function fetchTrackedTickers() {
                try {
                    console.log("üì¢ Fetching filtered tickers from settings...");

                    const settings = await window.settingsAPI.get();

                    // ‚úÖ Ensure `filteredTickers` exists before using it
                    if (!settings.news?.filteredTickers) {
                        console.warn("‚ö†Ô∏è No filtered tickers found in settings! Defaulting to an empty set.");
                        settings.news.filteredTickers = [];
                    }

                    // ‚úÖ Update the global settings object
                    window.settings = settings;

                    trackedTickers = new Set(settings.news.filteredTickers);
                    console.log("‚úÖ Tracked Tickers (Filtered):", trackedTickers);

                    updateNewsTable(); // Refresh table after updating tickers

                    console.log("‚úÖ Tracked Tickers (Filtered):", trackedTickers);

                    updateNewsTable(); // Refresh table after updating tickers
                } catch (error) {
                    console.error("‚ö†Ô∏è Error fetching filtered tickers:", error);
                }
            }

            async function fetchNews() {
                try {
                    console.log("üì¢ Fetching news...");

                    const newsData = await window.newsAPI.get();
                    console.log("üì∞ Received news:", newsData);

                    if (!Array.isArray(newsData)) {
                        console.error("‚ö†Ô∏è Expected an array but got:", newsData);
                        return;
                    }

                    allNews = newsData;
                    updateNewsTable();
                } catch (error) {
                    console.error("‚ö†Ô∏è Error fetching news:", error);
                    document.querySelector("#news-table tbody").innerHTML = `<tr><td colspan="6" class='info draggable'>Error fetching news: ${error.message}</td></tr>`;
                }
            }

            async function loadSettings() {
                try {
                    console.log("üì¢ Fetching settings...");
                    window.settings = await window.settingsAPI.get();

                    if (!window.settings.news) {
                        console.log("‚ö†Ô∏è `settings.news` is missing, initializing...");
                        window.settings.news = {};
                    }

                    console.log("‚úÖ Loaded settings:", window.settings);
                } catch (error) {
                    console.error("‚ö†Ô∏è Error loading settings:", error);
                    window.settings = { news: {} }; // Fallback
                }
            }

            function updateNewsTable() {
    console.log("üì¢ Updating news table...");

    const showOnlyTracked = window.settings.news.showTrackedTickers ?? false;
    const allowMultiSymbols = window.settings.news.allowMultiSymbols ?? true;
    const tableBody = document.querySelector("#news-table tbody");
    tableBody.innerHTML = "";

    const blockList = window.settings.news?.blockList || [];
    const bullishList = window.settings.news?.bullishList || [];
    const bearishList = window.settings.news?.bearishList || [];

    let filteredNews = allNews;

    if (showOnlyTracked) {
        filteredNews = filteredNews.filter((newsItem) =>
            newsItem.symbols && newsItem.symbols.some((symbol) => trackedTickers.has(symbol.toUpperCase()))
        );
    }

    if (!allowMultiSymbols) {
        filteredNews = filteredNews.filter((newsItem) => newsItem.symbols.length <= 1);
    }

    console.log("üìä Filtered News:", filteredNews);

    if (filteredNews.length === 0) {
        tableBody.innerHTML =
            "<tr><td colspan='4' class='info draggable'>No news available.</td></tr>";
        return;
    }

    const uniqueNews = new Map();
    filteredNews.forEach((newsItem) => {
        const key = `${newsItem.symbols?.join(",") || "N/A"}|${newsItem.headline}`;
        if (!uniqueNews.has(key)) {
            uniqueNews.set(key, newsItem);
        }
    });

    let sortedNews = Array.from(uniqueNews.values()).sort(
        (a, b) => new Date(b.created_at) - new Date(a.created_at)
    );

    console.log("üìä Sorted News Ready for Table:", sortedNews);

    const now = new Date();

    sortedNews.forEach((article) => {
        const headline = decodeHTMLEntities(article.headline || "");
        const articleURL = article.url || "#";

        const isBlocked = blockList.some((blockedWord) =>
            headline.toLowerCase().includes(blockedWord.toLowerCase())
        );

        if (!isBlocked) {
            // Create a new table row
            const row = document.createElement("tr");

            // Create a single cell that shows only the symbol
            const symbolCell = document.createElement("td");
            symbolCell.className = "draggable";
            const symbolText = article.symbols ? article.symbols.join(", ") : "N/A";
            symbolCell.textContent = symbolText;

            // Set the tooltip to display the headline
            symbolCell.title = `Headline: ${headline}`;

            // Optionally, add bullish or bearish styling based on the headline
            if (bullishList.some((goodWord) => headline.toLowerCase().includes(goodWord.toLowerCase()))) {
                symbolCell.classList.add("bullish-news");
            }
            if (bearishList.some((badWord) => headline.toLowerCase().includes(badWord.toLowerCase()))) {
                symbolCell.classList.add("bearish-news");
            }

            row.appendChild(symbolCell);

            // Optionally, if you want the cell to be clickable to go to the article, you can wrap the symbol in an anchor element.
            // For example:
            // const link = document.createElement("a");
            // link.href = articleURL;
            // link.textContent = symbolText;
            // link.target = "_blank";
            // link.rel = "noopener noreferrer";
            // link.title = `Headline: ${headline}`;
            // symbolCell.innerHTML = "";
            // symbolCell.appendChild(link);

            const newsAge = (now - new Date(article.created_at)) / 1000;
            if (newsAge >= 300) {
                row.classList.add("fade-out");
            }

            tableBody.appendChild(row);
        }
    });

    console.log("‚úÖ News table updated!");
}

            /**
             * ‚úÖ Helper Function: Decodes HTML Entities (Fixes &amp; issue)
             */
            function decodeHTMLEntities(text) {
                const parser = new DOMParser();
                const decodedString = parser.parseFromString(text, "text/html").body.textContent;
                return decodedString || text;
            }

            // ‚úÖ Listen for global settings updates and apply changes dynamically
            // ‚úÖ Listen for global settings updates and refresh news dynamically
            window.settingsAPI.onUpdate(async (updatedSettings) => {
                console.log("üîÑ Received 'settings-updated' event. Checking changes...");

                const prevSettings = JSON.stringify(window.settings.news);
                window.settings = updatedSettings;

                const newSettings = JSON.stringify(updatedSettings.news);

                // ‚úÖ If any settings changed, update news
                if (prevSettings !== newSettings) {
                    console.log("‚úÖ Detected news settings change, refreshing news table...");
                    updateNewsTable();
                } else {
                    console.log("‚ö†Ô∏è No relevant news settings changed. Ignoring update.");
                }
            });

            // ‚úÖ Listen for updates
            window.topAPI.onTickerUpdate(() => {
                console.log("üîÑ Received tickers-updated event. Refreshing tickers...");
                fetchTrackedTickers();
            });

            window.newsAPI.onUpdate(() => {
                console.log("üîÑ Received news update. Fetching fresh news...");
                fetchNews();
            });

            // ‚úÖ Initial fetch
            loadSettings().then(() => {
                fetchTrackedTickers().then(fetchNews);
            });
        </script>
    </body>
</html>
