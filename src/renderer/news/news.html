<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>News Viewer</title>
        <link rel="stylesheet" href="../styles.css" />
        <link rel="stylesheet" href="./news.css">
    </head>
    <body>
        <div id="news-wrapper">
            <table id="news-table">
                <tbody>
                    <tr>
                        <td colspan="6">Loading news...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", () => {
    let collapseTimeout;
    const wrapper = document.getElementById("news-wrapper");
    const table = document.getElementById("news-table");

    document.body.addEventListener("mouseenter", () => {
        clearTimeout(collapseTimeout);

        // Get the table's full height dynamically
        const tableHeight = table.scrollHeight;

        // Resize Electron window and wrapper dynamically based on table content
        window.newsAPI.setBounds({ width: 955, height: tableHeight });
        wrapper.style.height = `${tableHeight}px`;
    });

    document.body.addEventListener("mouseleave", () => {
        wrapper.style.height = "50px"; // Collapse smoothly
        
        collapseTimeout = setTimeout(() => {
            window.newsAPI.setBounds({ width: 955, height: 50 });
        }, 1000);
    });
});

        </script>

        <script>
            let allNews = [];
            let trackedTickers = new Set();

            async function fetchTrackedTickers() {
                try {
                    console.log("üì¢ Fetching tracked tickers...");

                    const tickers = await window.topAPI.getTickers("daily");
                    trackedTickers = new Set(tickers.map((t) => t.Symbol?.toUpperCase()));

                    console.log("‚úÖ Tracked Tickers:", trackedTickers);

                    updateNewsTable(); // Refresh table after updating tickers
                } catch (error) {
                    console.error("‚ö†Ô∏è Error fetching tracked tickers:", error);
                }
            }

            async function fetchNews() {
                try {
                    console.log("üì¢ Fetching news...");

                    const newsData = await window.newsAPI.get();
                    console.log("üì∞ Received news:", newsData);

                    if (!Array.isArray(newsData)) {
                        console.error("‚ö†Ô∏è Expected an array but got:", newsData);
                        return;
                    }

                    allNews = newsData;
                    updateNewsTable();
                } catch (error) {
                    console.error("‚ö†Ô∏è Error fetching news:", error);
                    document.querySelector("#news-table tbody").innerHTML = `<tr><td colspan="6" class='info draggable'>Error fetching news: ${error.message}</td></tr>`;
                }
            }

            async function loadSettings() {
                try {
                    console.log("üì¢ Fetching settings...");
                    window.settings = await window.settingsAPI.get();

                    if (!window.settings.news) {
                        console.log("‚ö†Ô∏è `settings.news` is missing, initializing...");
                        window.settings.news = {};
                    }

                    console.log("‚úÖ Loaded settings:", window.settings);
                } catch (error) {
                    console.error("‚ö†Ô∏è Error loading settings:", error);
                    window.settings = { news: {} }; // Fallback
                }
            }

            function updateNewsTable() {
                console.log("üì¢ Updating news table...");

                const showOnlyTracked = window.settings.news.showTrackedTickers ?? false;
                const tableBody = document.querySelector("#news-table tbody");
                tableBody.innerHTML = "";

                let filteredNews = allNews;
                if (showOnlyTracked) {
                    filteredNews = allNews.filter((newsItem) => newsItem.symbols && newsItem.symbols.some((symbol) => trackedTickers.has(symbol.toUpperCase())));
                }

                console.log("üìä Filtered News:", filteredNews);

                if (filteredNews.length === 0) {
                    console.warn("‚ö†Ô∏è No news available after filtering.");
                    tableBody.innerHTML = "<tr><td colspan='1' class='info draggable'>No news available.</td></tr>";
                    return;
                }

                // ‚úÖ Sort news by time (newest first)
                let sortedNews = filteredNews.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                console.log("üìä Sorted News Ready for Table:", sortedNews);

                const now = new Date();

                // ‚úÖ Append sorted news to the table
                sortedNews.forEach((article) => {
                    const row = document.createElement("tr");

                    row.innerHTML = `
                        <td class='draggable'>${article.symbols ? article.symbols.join(", ") : "N/A"}</td>
                        <td class="no-drag"><a href="${article.url}" target="_blank">${article.headline || "No headline"}</a></td>
                        <td>${article.source || "N/A"}</td>
                        <td>${article.created_at ? new Date(article.created_at).toLocaleString() : "N/A"}</td>
                    `;

                    // ‚úÖ Calculate time difference in seconds
                    const newsAge = (now - new Date(article.created_at)) / 1000;

                    // ‚úÖ If the news is older than 5 minutes, start fading out
                    if (newsAge >= 300) {
                        row.classList.add("fade-out");
                    }

                    tableBody.appendChild(row);
                });

                console.log("‚úÖ News table updated!");
            }

            // ‚úÖ Listen for global settings updates and apply changes dynamically
            window.settingsAPI.onUpdate((updatedSettings) => {
                console.log("üîÑ Received 'settings-updated' event. Applying updated settings...", updatedSettings);

                window.settings = updatedSettings;
                updateNewsTable();
            });

            // ‚úÖ Listen for updates
            window.topAPI.onTickerUpdate(() => {
                console.log("üîÑ Received tickers-updated event. Refreshing tickers...");
                fetchTrackedTickers();
            });

            window.newsAPI.onUpdate(() => {
                console.log("üîÑ Received news update. Fetching fresh news...");
                fetchNews();
            });

            // ‚úÖ Initial fetch
            loadSettings().then(() => {
                fetchTrackedTickers().then(fetchNews);
            });
        </script>
    </body>
</html>
